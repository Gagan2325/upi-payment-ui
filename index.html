<!DOCTYPE html>
<html>
<head>
  <title>UPI Smart Pay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: system-ui;
  background: #f1f3f4;
  margin: 0;
}
.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}
.card {
  background: #fff;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 4px 16px rgba(0,0,0,.08);
}
#payBtn {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  width: calc(100% - 32px);
  max-width: 420px;
  padding: 16px;
  font-size: 1.2rem;
  font-weight: 600;
  border: none;
  border-radius: 14px;
  background: #1a73e8;
  color: #fff;
  display: none;
}
.offer {
  background: #e8f0fe;
  color: #174ea6;
  font-weight: 600;
}
</style>
</head>

<body>
<div class="container">
  <h2>Scan & Pay</h2>

  <div class="card">
    <div id="reader"></div>
  </div>

  <div class="card" id="merchantCard" style="display:none;">
    <b id="merchantName"></b>
    <div id="merchantUpi"></div>
  </div>

  <div class="card offer" id="offerCard" style="display:none;"></div>

  <div class="card" id="statusCard" style="display:none;"></div>
</div>

<button id="payBtn">Pay Now</button>

<script>
let scannedUpiUrl = "";
let txnId = "";

const payBtn = document.getElementById("payBtn");
const offerCard = document.getElementById("offerCard");
const statusCard = document.getElementById("statusCard");

function onScanSuccess(text) {
  scannedUpiUrl = text;

  const url = new URL(text);
  const name = decodeURIComponent(url.searchParams.get("pn") || "Merchant");
  const upi = url.searchParams.get("pa");
  const amount = parseInt(url.searchParams.get("am") || "100");

  merchantName.textContent = name;
  merchantUpi.textContent = upi;
  merchantCard.style.display = "block";

  fetch("https://upi-payment-git-main-gagan2325s-projects.vercel.app/api/payment/init", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ amount })
  })
  .then(r=>r.json())
  .then(d=>{
    txnId = d.txnId;
    offerCard.textContent = `üéâ Pay now & get ‚Çπ${d.cashback} cashback`;
    offerCard.style.display = "block";
    payBtn.style.display = "block";
  });
}

payBtn.onclick = () => {
  const url = new URL(scannedUpiUrl);
  url.searchParams.set("tr", txnId);
  url.searchParams.set("tn", "UPI Smart Pay");

  window.location.href = url.toString();

  statusCard.style.display = "block";
  statusCard.textContent = "‚è≥ Waiting for payment...";

  const poll = setInterval(() => {
    fetch(`https://upi-payment-git-main-gagan2325s-projects.vercel.app/api/payment/${txnId}`)
      .then(r=>r.json())
      .then(d=>{
        if (d.status !== "PENDING") {
          statusCard.textContent =
            d.status === "SUCCESS"
              ? "‚úÖ Payment Successful"
              : "‚ùå Payment Failed";
          clearInterval(poll);
        }
      });
  }, 3000);
};

new Html5Qrcode("reader").start(
  { facingMode:"environment" },
  { fps:10, qrbox:250 },
  onScanSuccess
);

// PWA
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
